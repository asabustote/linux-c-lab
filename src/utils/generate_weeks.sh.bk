#!/usr/bin/env bash
# generate_phase.sh - Auto-generate weekly issue templates for linux-c-lab

###############################################################################
# 0. linux-c-lab root auto-detection
###############################################################################
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

find_linux_c_lab_root() {
    local dir="$SCRIPT_DIR"
    while [[ "$dir" != "/" ]]; do
        if [[ "$(basename "$dir")" == "linux-c-lab" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

LAB_ROOT="$(find_linux_c_lab_root)"
if [[ -z "$LAB_ROOT" ]]; then
    echo "[ERROR] linux-c-lab root not found."
    exit 1
fi

ISSUES_DIR="$LAB_ROOT/issues"

###############################################################################
# 1. Roadmap (Phase 1 Example) â€” You can extend for Phase 2, 3, 4
###############################################################################
# Week definitions (example: Design Week â†’ Week01, Blog Week â†’ Week06)

declare -A GOALS
declare -A TODOS
declare -A REFERENCES
declare -A NEXT_WEEK

# Week01 (Design Week)
GOALS[1]="Linux-c-lab ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®è¨­è¨ˆé€±é–“"
TODOS[1]="- [ ] ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®æœ€çµ‚æ±ºå®š
- [ ] å¿…è¦ã¨ãªã‚‹ã‚µãƒ¼ãƒæ§‹æˆã®æ´—ã„å‡ºã—
- [ ] ä½¿ç”¨æŠ€è¡“ã®ä¸€è¦§åŒ–
- [ ] Phase1ã€œPhase4ã®ç²’åº¦èª¿æ•´"
REFERENCES[1]="- Linux FHS
- systemd ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- Cãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ å‚è€ƒè³‡æ–™"
NEXT_WEEK[1]="Week02: Ubuntuç’°å¢ƒæ§‹ç¯‰ + åŸºæœ¬è¨­å®š"

# Week02
GOALS[2]="Ubuntuä»®æƒ³ç’°å¢ƒæ§‹ç¯‰ã¨åˆæœŸè¨­å®š"
TODOS[2]="- [ ] Multipass ã§ VM æ§‹ç¯‰
- [ ] SSHéµèªè¨¼è¨­å®š
- [ ] ufw ã®åŸºæœ¬è¨­å®š
- [ ] Neovim å°å…¥ã¨æœ€ä½é™ã®è¨­å®š"
REFERENCES[2]="- Multipass Docs
- OpenSSH Docs
- Neovim Docs"
NEXT_WEEK[2]="Week03: systemd ã‚µãƒ¼ãƒ“ã‚¹ç†è§£ + ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŸºç¤"

# Week03
GOALS[3]="systemd åŸºç¤ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç†è§£"
TODOS[3]="- [ ] systemd ã§ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ãƒ†ã‚¹ãƒˆ
- [ ] basic target/wants ã®èª­è§£
- [ ] Ping/TCP/UDP ã®æŒ™å‹•ç¢ºèª
- [ ] Cè¨€èª ã§ç°¡æ˜“TCPã‚µãƒ¼ãƒé››å½¢ã‚’æ›¸ã"
REFERENCES[3]="- systemd.unit
- Beej's Network Guide"
NEXT_WEEK[3]="Week04: Cè¨€èªåŸºç¤ + TCPã‚µãƒ¼ãƒå®Ÿè£…"

# Week04
GOALS[4]="Cè¨€èªåŸºç¤ã¨TCPã‚µãƒ¼ãƒå®Ÿè£…ã®æœ¬æ ¼åŒ–"
TODOS[4]="- [ ] ãƒã‚¤ãƒ³ã‚¿ã®ãŠã•ã‚‰ã„
- [ ] ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ¡ãƒ¢ãƒªç®¡ç†å¼·åŒ–
- [ ] TCPã‚µãƒ¼ãƒ v1 ã‚’å®Œæˆã•ã›ã‚‹
- [ ] ãƒ­ã‚°å‡ºåŠ›åŸºç›¤ã®ä½œæˆ"
REFERENCES[4]="- K&R C Programming Language
- Linux Socket Programming"
NEXT_WEEK[4]="Week05: ç›£è¦–ãƒ„ãƒ¼ãƒ«åŸºç¤ + procfs èª­è§£"

# Week05
GOALS[5]="ç›£è¦–ãƒ„ãƒ¼ãƒ«é–‹ç™ºã¨procfsã®ç†è§£"
TODOS[5]="- [ ] CPUä½¿ç”¨ç‡ã®ç®—å‡ºæ–¹æ³•ç†è§£
- [ ] /proc/stat ã®è§£æ
- [ ] Cã§CPUä½¿ç”¨ç‡å–å¾—ãƒ—ãƒ­ã‚°ãƒ©ãƒ ä½œæˆ
- [ ] Makefile å¼·åŒ–"
REFERENCES[5]="- procfs docs
- Linux Performance Book"
NEXT_WEEK[5]="Week06: ãƒ–ãƒ­ã‚°é€±é–“ï¼ˆã¾ã¨ã‚ + å…¬é–‹ï¼‰"

# Week06 (Blog Week)
GOALS[6]="1ã€œ5é€±ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆæ•´ç†ã¨ãƒ–ãƒ­ã‚°å…¬é–‹"
TODOS[6]="- [ ] æŠ€è¡“ãƒ–ãƒ­ã‚°åŸ·ç­†
- [ ] ã‚³ãƒ¼ãƒ‰æ•´ç†
- [ ] GitHubæ•´ç†
- [ ] Phase1ã¾ã¨ã‚"
REFERENCES[6]="- Zenn / Qiita guidelines"
NEXT_WEEK[6]="Phase2 ã¸é€²ã‚€æº–å‚™"

###############################################################################
# 2. Generation Logic
###############################################################################
if [[ -z "$1" ]]; then
    echo "Usage: ./generate_phase.sh phase01"
    exit 1
fi

PHASE="$1"
PHASE_DIR="$ISSUES_DIR/$PHASE"

mkdir -p "$PHASE_DIR"

for i in {1..6}; do
    WEEK="week$(printf "%02d" $i)"
    FILE="$PHASE_DIR/$WEEK.md"

    cat <<EOF >"$FILE"
# ${WEEK}

## ğŸ¯ ä»Šé€±ã®ç›®æ¨™
${GOALS[$i]}

---

## âœ… ToDoï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
${TODOS[$i]}

---

## ğŸ“˜ å­¦ç¿’è¨˜éŒ²ãƒ»æŠ€è¡“ãƒ–ãƒ­ã‚°ãƒ¡ãƒ¢
$(if [ -n "$logs" ]; then echo -e "$logs" | sed 's/^/- /'; else echo "- "; fi)

---

## ğŸ•’ å®Ÿç¸¾æ™‚é–“
- åœŸæ›œï¼š
- æ—¥æ›œï¼š
- **åˆè¨ˆ**ï¼š

---
## ğŸ“š å‚è€ƒè³‡æ–™
${REFERENCES[$i]}

---

## ğŸ”® æ¬¡é€±ã®äºˆå®š
${NEXT_WEEK[$i]}
EOF

    echo "Generated: $FILE"
done

echo "\n[OK] Phase files generated in: $PHASE_DIR"
